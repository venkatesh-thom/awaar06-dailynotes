===
ISTIO CONFIGURATION
===

istio Documentation page: https://istio.io/latest/docs/setup/getting-started/

Download the latest istio:
curl -L https://istio.io/downloadIstio | sh -

cd istio-1.28.0

export PATH=$PWD/bin:$PATH


istioctl install -f samples/bookinfo/demo-profile-no-gateways.yaml -y

kubectl label namespace default istio-injection=enabled

---

For testing purposes: Create a pod in default namespace, you should automatically get the sidecar container / envoy proxy..


---


kubectl get pods -n istio-system

kubectl get crd gateways.gateway.networking.k8s.io &> /dev/null || \
{ kubectl kustomize "github.com/kubernetes-sigs/gateway-api/config/crd?ref=v1.4.0" | kubectl apply -f -; }


kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml


kubectl get services

kubectl get pods

validate: 
kubectl exec "$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')" -c ratings -- curl -sS productpage:9080/productpage | grep -o "<title>.*</title>"

Above command should display book title text.. 

====

kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/latest/download/standard-install.yaml


kubectl apply -f samples/bookinfo/gateway-api/bookinfo-gateway.yaml

kubectl annotate gateway bookinfo-gateway networking.istio.io/service-type=ClusterIP --namespace=default

kubectl get gateway

kubectl port-forward svc/bookinfo-gateway-istio 8081:80 -n default


====


kubectl run curl-naked \
  -n default \
  --image=curlimages/curl:8.4.0 \
  --annotations='sidecar.istio.io/inject=false' \
  -- sleep 3600

kubectl exec -n default -it curl-naked -- \
  curl -v http://productpage:9080/productpage


---

If mTLS is STRICT → curl fails (503 or connection error)

If mTLS is PERMISSIVE → curl succeeds (200 OK)



---
Now apply strict mTLS

apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: default
spec:
  mtls:
    mode: STRICT


--

kubectl exec -n default -it curl-naked -- \
  curl -v http://productpage:9080/productpage

--


kubectl run curl-naked-2 \
  -n default \
  --image=curlimages/curl:8.4.0 \
  -- sleep 3600

kubectl exec -n default -it curl-naked-2 -- \
  curl -v http://productpage:9080/productpage


-------


git clone https://github.com/istio/istio.git
kubectl apply -f samples/addons

===

navigate back to istio downloaded folder..

kubectl apply -f samples/addons/kiali.yaml
kubectl rollout status deployment/kiali -n istio-system

istioctl dashboard kiali

for i in $(seq 1 100); do curl -s -o /dev/null "http://localhost:8081/productpage"; done

---
